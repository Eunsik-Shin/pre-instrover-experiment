<!-- path: index.html -->
<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Experiment Page</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .dropzone{border:1px dashed rgba(0,0,0,.2)}
    .blink{animation: blink 1s step-end 6}
    @keyframes blink{50%{outline-color:transparent}}
  </style>
</head>
<body class="bg-white text-gray-900">
  <header class="sticky top-0 z-20 backdrop-blur bg-white/70 border-b">
    <div class="max-w-5xl mx-auto px-4 py-4 flex items-center gap-3">
      <div class="text-2xl font-semibold">🎧 Experiment Page</div>
      <div class="ml-auto flex items-center gap-3 text-sm">
        <label class="flex items-center gap-2">파일 기본 경로:
          <input id="basePath" type="text" class="border rounded px-2 py-1 w-52" placeholder="./assets/" />
        </label>
        <button id="exportCsv" class="border rounded px-3 py-1">CSV 내보내기</button>
        <button id="resetAll" class="border rounded px-3 py-1">초기화</button>
      </div>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 py-6">
    <section class="mb-6">
      <h2 class="text-lg font-semibold mb-2">실험 개요</h2>
      <ul class="list-disc pl-5 space-y-1 text-sm leading-relaxed">
        <li>각 소리와 비슷한 악기를 직접 찾아봅니다.</li>
        <li>각 카테고리 별 태그를 사용하셔도 좋고, 검색어 입력으로도 찾을 수 있습니다.</li>
        <li>구성: <b>(Category) &gt; (Subcategory) &gt; (Preset)</b></li>
        <li>각 악기명 왼쪽 ⭐️ rating 기능을 들었던 악기 표기나 유사도 표기로 자유롭게 사용하셔도 됩니다.</li>
        <li>아래 메모란에 소리를 듣고 든 생각, 느낌, 특징 등 적고싶은 내용을 자유롭게 적으셔도 됩니다.</li>
        <li>각 악기별 검색 시간은 5분 제한입니다.</li>
      </ul>
    </section>

    <section id="cards" class="space-y-6"></section>

    <footer class="mt-12 text-xs text-gray-500">
      <p>GitHub Pages · All rights reserved</p>
    </footer>
  </main>

<script>
  // ---------- 데이터 ----------
  const DATA = [
    { id:'sound1', title:'Sound 1', category:'Pad', subcategory:'Fast attack', preset:'', files:[
      { label:'C2 (vel 80)', filename:'metallic_sweep_c2_1.wav' },
      { label:'C3 (vel 80)', filename:'metallic_sweep_c3_1.wav' },
      { label:'C4 (vel 80)', filename:'metallic_sweep_c4_1.wav' },
      { label:'C5 (vel 80)', filename:'metallic_sweep_c5_1.wav' },
      { label:'C6 (vel 80)', filename:'metallic_sweep_c6_1.wav' },
      { label:'C4 (vel 127)', filename:'Metallic_Sweeps_long_1.wav', long:true },
    ]},
    { id:'sound2', title:'Sound 2', category:'Strings', subcategory:'All', preset:'', files:[
      { label:'C2 (vel 80)', filename:'Motion_glory_wave_c2_2.wav' },
      { label:'C3 (vel 80)', filename:'Motion_glory_wave_c3_2.wav' },
      { label:'C4 (vel 80)', filename:'Motion_glory_wave_c4_2.wav' },
      { label:'C5 (vel 80)', filename:'Motion_glory_wave_c5_2.wav' },
      { label:'C6 (vel 80)', filename:'Motion_glory_wave_c6_2.wav' },
      { label:'C4 (vel 127)', filename:'Motion_glory_wave_long.wav', long:true },
    ]},
    { id:'sound3', title:'Sound 3', category:'Mallet', subcategory:'Layered', preset:'', files:[
      { label:'C2 (vel 80)', filename:'Light_mallet_echo_layers_c2_1.wav' },
      { label:'C3 (vel 80)', filename:'Light_mallet_echo_layers_c3_1.wav' },
      { label:'C4 (vel 80)', filename:'Light_mallet_echo_layers_c4_1.wav' },
      { label:'C5 (vel 80)', filename:'Light_mallet_echo_layers_c5_1.wav' },
      { label:'C6 (vel 80)', filename:'Light_mallet_echo_layers_c6_1.wav' },
      { label:'C4 (vel 127)', filename:'Light_mallet_echo_wave_long.wav', long:true },
    ]},
    { id:'sound4', title:'Sound 4', category:'Synth', subcategory:'Mono', preset:'', files:[
      { label:'C2 (vel 80)', filename:'Limbo_c2_1.wav' },
      { label:'C3 (vel 80)', filename:'Limbo_c3_1.wav' },
      { label:'C4 (vel 80)', filename:'Limbo_c4_1.wav' },
      { label:'C5 (vel 80)', filename:'Limbo_c5_1.wav' },
      { label:'C6 (vel 80)', filename:'Limbo_c6_1.wav' },
      { label:'C4 (vel 127)', filename:'Limbo_long_2.wav', long:true },
    ]},
    { id:'sound5', title:'Sound 5', category:'Keys', subcategory:'Layered', preset:'', files:[
      { label:'C2 (vel 80)', filename:'Lonely_beacon_c2_1.wav' },
      { label:'C3 (vel 80)', filename:'Lonely_beacon_c3_1.wav' },
      { label:'C4 (vel 80)', filename:'Lonely_beacon_c4_1.wav' },
      { label:'C5 (vel 80)', filename:'Lonely_beacon_c5_1.wav' },
      { label:'C6 (vel 80)', filename:'Lonely_beacon_c6_1.wav' },
      { label:'C4 (vel 127)', filename:'Lonely_beacon_long_1.wav', long:true },
    ]},
  ];

  // ---------- 상태 ----------
  // 왜: 경로/업로드 키만 저장. note는 세션 전용(저장하지 않음).
  const LS_KEY = 'sound-demo-state-v2';
  const state = loadState();
  function loadState(){ try{ return JSON.parse(localStorage.getItem(LS_KEY))||{} }catch{ return {} } }
  function saveState(){ localStorage.setItem(LS_KEY, JSON.stringify(state)) }

  // ---------- IndexedDB (브라우저 영구 저장) ----------
  const DB_NAME='sound-demo-idb', DB_VERSION=1, STORE='uploads';
  let _db=null;
  function idbOpen(){
    return new Promise((res,rej)=>{
      if(!('indexedDB' in window)) return rej(new Error('IndexedDB not supported'));
      const req = indexedDB.open(DB_NAME, DB_VERSION);
      req.onupgradeneeded = ()=>{ const db=req.result; if(!db.objectStoreNames.contains(STORE)) db.createObjectStore(STORE); };
      req.onsuccess = ()=> res(req.result);
      req.onerror = ()=> rej(req.error||new Error('idb open error'));
    });
  }
  async function idb(){ return _db || (_db = await idbOpen()); }
  async function idbGet(key){
    try{
      const db = await idb();
      return await new Promise((res,rej)=>{
        const tx=db.transaction(STORE,'readonly'); const st=tx.objectStore(STORE);
        const r=st.get(key); r.onsuccess=()=>res(r.result||null); r.onerror=()=>rej(r.error);
      });
    }catch{ return null }
  }
  async function idbSet(key, blob){
    const db = await idb();
    return await new Promise((res,rej)=>{
      const tx=db.transaction(STORE,'readwrite'); tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error);
      tx.objectStore(STORE).put(blob, key);
    });
  }
  async function idbClear(){
    try{
      const db = await idb();
      return await new Promise((res,rej)=>{
        const tx=db.transaction(STORE,'readwrite'); tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error);
        tx.objectStore(STORE).clear();
      });
    }catch{}
  }
  // 영구 저장 요청(가능 시 스토리지 휘발 방지)
  if (navigator.storage && navigator.storage.persist) { navigator.storage.persist().catch(()=>{}); }

  // ---------- 유틸 ----------
  const $ = sel => document.querySelector(sel);
  const e = (tag, props={}, ...children)=>{ const el=document.createElement(tag); Object.assign(el, props); for(const c of children){ if(c==null) continue; el.append(c.nodeType?c:document.createTextNode(c)); } return el; };
  const fmt = n => n.toString().padStart(2,'0');
  function encPath(base, name){ const b = base?.trim(); const joined = (b? (b.endsWith('/')? b:b+'/') : '') + name; return encodeURI(joined); }

  // ---------- 오디오 소스 ----------
  async function setAudioSrc(audioEl, soundId, filename){
    const key = `${soundId}/${filename}`;
    const blob = await idbGet(key);
    if (blob) { audioEl.src = URL.createObjectURL(blob); return; }
    const base = state.basePath || './assets/';
    audioEl.src = encPath(base, filename);
  }

  // ---------- 비프 알림 ----------
  function beep(ms=800, freq=880){
    try{
      const ac = new (window.AudioContext||window.webkitAudioContext)();
      const o = ac.createOscillator(); const g = ac.createGain();
      o.type='sine'; o.frequency.value=freq;
      o.connect(g); g.connect(ac.destination);
      g.gain.setValueAtTime(0.6, ac.currentTime); // ← 음량 상향
      g.gain.exponentialRampToValueAtTime(0.0001, ac.currentTime + ms/1000);
      o.start(); o.stop(ac.currentTime + ms/1000 + 0.05);
    }catch{}
  }

  // ---------- 렌더 ----------
  const cards = $('#cards');
  const basePathInput = $('#basePath');
  if(!state.basePath){ state.basePath = './assets/'; saveState(); }
  basePathInput.value = state.basePath || './assets/';
  basePathInput.addEventListener('change', ()=>{ state.basePath = basePathInput.value; saveState(); render(); });

  function addTimerUI(container){
    const timeText = e('span', { className:'font-mono text-sm' }, '05:00');
    const startBtn = e('button', { className:'border rounded px-2 py-1 text-xs' }, '5분 시작');
    const stopBtn  = e('button', { className:'border rounded px-2 py-1 text-xs' }, '정지');
    let startAt=null, rafId=null, expired=false;

    function update(){
      if(!startAt){ timeText.textContent='05:00'; return; }
      const elapsed = Math.floor((Date.now()-startAt)/1000);
      const remain = Math.max(0, 300 - elapsed);
      const mm = fmt(Math.floor(remain/60)), ss = fmt(remain%60);
      timeText.textContent = `${mm}:${ss}`;
      if(remain===0 && !expired){
        expired=true;
        container.classList.add('blink');
        beep(900,880);
        setTimeout(()=>container.classList.remove('blink'), 6000);
      }
      rafId = requestAnimationFrame(update);
    }
    startBtn.addEventListener('click', ()=>{ expired=false; startAt = Date.now(); if(!rafId) rafId=requestAnimationFrame(update); });
    stopBtn.addEventListener('click', ()=>{ startAt=null; expired=false; if(rafId){ cancelAnimationFrame(rafId); rafId=null; } update(); });
    update();
    return e('div', { className:'flex items-center gap-2' }, timeText, startBtn, stopBtn);
  }

  async function render(){
    cards.innerHTML = '';
    for(const s of DATA){
      const card = e('section', { className:'rounded-2xl border p-4 shadow-sm' });

      const path = e('div', { className:'text-sm text-gray-600' }, `${s.category} › ${s.subcategory}${s.preset? ' › '+s.preset:''}`);
      const title = e('div', { className:'text-lg font-semibold' }, s.title);
      const headerLeft = e('div', { className:'flex items-center gap-3' }, title);
      const headerRight = e('div', { className:'flex items-center gap-3' }, path);
      const header = e('div', { className:'flex items-start justify-between mb-3' }, headerLeft, headerRight);

      // 타이머(카드 상단)
      const timerBar = addTimerUI(card);

      const list = e('div', { className:'grid grid-cols-1 md:grid-cols-2 gap-3' });

      const playSeq = e('button', { className:'border rounded px-3 py-2 text-sm mb-2' }, '연속 재생 (C2→C6)');
      let seqAbort = false;
      playSeq.addEventListener('click', async()=>{
        seqAbort = false;
        const nodes = [...list.querySelectorAll('audio[data-short="1"]')];
        for(const a of nodes){
          if(seqAbort) break;
          try{
            await a.play();
            await new Promise(res=>a.addEventListener('ended', res, { once:true }));
          }catch{}
        }
      });
      const stopSeq = e('button', { className:'border rounded px-3 py-2 text-sm mb-2 ml-2' }, '정지');
      stopSeq.addEventListener('click', ()=>{ seqAbort = true; for(const a of list.querySelectorAll('audio')){ a.pause(); a.currentTime=0; } });

      // 메모(세션 전용)
      const note = e('textarea', { className:'border rounded p-2 w-full text-sm', rows:2, placeholder:'메모' });

      for(const f of s.files){
        const row = e('div', { className:'border rounded-lg p-3 flex flex-col gap-2' });

        // 표시 라벨에서 "· 1s/3s"만 제거(vel 표기는 유지)
        const displayLabel = f.label.replace(/\s*·\s*\d+s/ig, '');

        const label = e('div', { className:'flex items-center justify-between' },
          e('div', { className:'font-medium' }, displayLabel),
          e('div', { className:'text-xs text-gray-600' }, '\u00A0') // 파일명 숨김
        );

        const audio = e('audio', { controls:true });
        audio.dataset.short = f.long ? '0' : '1';
        // 비동기 소스 로드
        setAudioSrc(audio, s.id, f.filename);

        // 일시정지 시 재생점 0으로 리셋(ended 제외)
        audio.addEventListener('pause', ()=>{ if(!audio.ended) audio.currentTime = 0; });

        // 업로드(드롭/클릭) → IndexedDB에 영구 저장(이 브라우저)
        const dz = e('label', { className:'dropzone rounded px-3 py-2 text-xs text-gray-600 cursor-pointer' }, '여기에 파일 드롭 또는 클릭하여 업로드');
        const fileInput = e('input', { type:'file', accept:'.wav,audio/wav', style:'display:none' });
        dz.append(fileInput);
        dz.addEventListener('dragover', ev=>{ ev.preventDefault(); dz.classList.add('bg-gray-50'); });
        dz.addEventListener('dragleave', ()=> dz.classList.remove('bg-gray-50'));
        dz.addEventListener('drop', async ev=>{
          ev.preventDefault(); dz.classList.remove('bg-gray-50');
          const file = ev.dataTransfer.files?.[0];
          if(file){ await applyUpload(file); }
        });
        dz.addEventListener('click', ()=> fileInput.click());
        fileInput.addEventListener('change', async ()=>{ const f0=fileInput.files?.[0]; if(f0){ await applyUpload(f0); } });

        async function applyUpload(file){
          try{
            const key = `${s.id}/${f.filename}`;
            // 왜: 서버가 아닌 브라우저 DB에 Blob 저장
            await idbSet(key, file);
            await setAudioSrc(audio, s.id, f.filename);
          }catch(e){ alert('업로드를 저장할 수 없습니다(브라우저 제한). GitHub assets 사용을 고려하세요.'); }
        }

        row.append(label, audio, dz);
        list.append(row);
      }

      card.append(header, e('div', {className:'flex items-center mb-2'}, timerBar, e('div',{className:'grow'}), playSeq, stopSeq), list, e('div',{className:'mt-3'}, note));
      cards.append(card);
    }
  }

  // ---------- 전역 컨트롤 ----------
  $('#exportCsv').addEventListener('click', ()=>{
    const rows = [['id','title','category','subcategory','label','override_uploaded']];
    for(const s of DATA){
      for(const f of s.files){
        rows.push([ s.id, s.title, s.category, s.subcategory, f.label.replace(/\s*·\s*\d+s/ig, ''), '(알 수 없음: 로컬 업로드 여부는 각 브라우저마다 다름)' ]);
      }
    }
    const csv = rows.map(r=>r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'sound_experiment_simple.csv';
    a.click();
  });

  $('#resetAll').addEventListener('click', async ()=>{
    if(!confirm('모든 저장 데이터(경로/로컬 업로드)를 초기화할까요? \n※ 메모는 원래 세션 전용입니다.')) return;
    localStorage.removeItem(LS_KEY);
    await idbClear(); // 왜: 업로드된 Blob도 삭제
    location.reload();
  });

  // 초기화
  for(const s of DATA){ /* state에 메모 없음 */ }
  if(!state.basePath){ state.basePath = './assets/'; }
  saveState();
  render();


</script>
</body>
</html>
